<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í™ˆ</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        .token { word-break: break-all; background: #eee; padding: 0.5rem; margin-bottom: 1rem; }
        button { margin: 1rem 0; }
    </style>
</head>
<body>
<h1>í™ˆ</h1>

<h3>ì•¡ì„¸ìŠ¤ í† í°</h3>
<div class="token" id="access-token"></div>

<h3>ë¦¬í”„ë ˆì‹œ í† í°</h3>
<div class="token" id="refresh-token"></div>

<button id="refresh-btn">ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰</button>
<button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>

<!-- ğŸ”¥ ìƒˆë¡œ ì¶”ê°€ëœ íƒˆí‡´ ë²„íŠ¼ê³¼ íƒˆí‡´ ì‚¬ìœ  ì…ë ¥ -->
<h3>íšŒì›íƒˆí‡´</h3>
<textarea id="withdraw-reason" placeholder="íƒˆí‡´ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
<button id="withdraw-btn">íƒˆí‡´í•˜ê¸°</button>

<script>
    const accessTokenDiv = document.getElementById('access-token');
    const refreshTokenDiv = document.getElementById('refresh-token');

    function renderTokens() {
        accessTokenDiv.textContent = localStorage.getItem('accessToken') || '';
        refreshTokenDiv.textContent = localStorage.getItem('refreshToken') || '';
    }

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('accessToken');
        const refreshToken = urlParams.get('refreshToken');

        if (accessToken && refreshToken) {
            localStorage.setItem('accessToken', accessToken);
            localStorage.setItem('refreshToken', refreshToken);
        }

        renderTokens();
    };

    // ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰
    document.getElementById('refresh-btn').onclick = async () => {
        const refresh = localStorage.getItem('refreshToken');
        if (!refresh) return alert('ë¦¬í”„ë ˆì‹œ í† í° ì—†ìŒ');

        const res = await fetch('/users/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken: refresh })
        });

        if (res.status === 200) {
            const data = await res.json();
            localStorage.setItem('accessToken', data.accessToken);
            renderTokens();
            alert('ìƒˆë¡œìš´ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì™„ë£Œ');
        } else {
            alert('ë¦¬í”„ë ˆì‹œ ë§Œë£Œ! ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”');
            localStorage.clear();
            window.location.href = '/login.html';
        }
    };

    // ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logout-btn').onclick = async () => {
        const kakaoAccess = localStorage.getItem('accessToken');
        if (!kakaoAccess) return alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');

        const res = await fetch('/users/auth/logout', {
            method: 'POST',
            headers: {
                'Kakao-Access': kakaoAccess,
                'Authorization': 'Bearer ' + kakaoAccess
            }
        });

        if (res.status === 204) {
            alert('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            localStorage.clear();
            window.location.href = '/login.html';
        } else {
            alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
        }
    };

    // ğŸ”¥ íƒˆí‡´í•˜ê¸°
    document.getElementById('withdraw-btn').onclick = async () => {
        const reason = document.getElementById('withdraw-reason').value;
        if (!reason) {
            alert('íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const res = await fetch('/mypage/withdraw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({ withdrawReason: reason })
        });

        if (res.ok) {
            const msg = await res.text();
            alert(msg); // "íƒˆí‡´ê°€ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            localStorage.clear();
            window.location.href = '/login.html';
        } else {
            const error = await res.text();
            alert('íƒˆí‡´ ì‹¤íŒ¨: ' + error);
        }
    };
</script>
</body>
</html>
