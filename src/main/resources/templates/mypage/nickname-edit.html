<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>닉네임 수정</title>
</head>
<body>
<h2>닉네임 수정</h2>

<form id="nicknameForm" th:action="@{/mypage/user-nickname}" method="post">
    <label for="nickname">새 닉네임:</label>
    <input type="text" id="nickname" name="nickname" required>
    <button type="button" onclick="checkDuplicate()">중복 확인</button>
    <span id="checkResult" style="margin-left:10px;"></span>
    <br><br>
    <button type="button" onclick="submitNickname()">닉네임 저장</button>
</form>

<script>
    let isChecked = false;

    function checkDuplicate() {
        const nickname = document.getElementById("nickname").value.trim();
        const checkResult = document.getElementById("checkResult");
        const nicknameRegex = /^[가-힣a-zA-Z0-9]+$/;

        if (!nickname) {
            checkResult.innerText = "닉네임을 입력해주세요.";
            checkResult.style.color = "red";
            isChecked = false;
            return;
        }

        if (!nicknameRegex.test(nickname)) {
            checkResult.innerText = "닉네임은 공백이나 특수문자를 포함할 수 없습니다.";
            checkResult.style.color = "red";
            isChecked = false;
            return;
        }

        fetch(`/mypage/check-user-nickname?nickname=` + encodeURIComponent(nickname))
            .then(res => res.json())
            .then(data => {
                if (data.isDuplicated) {
                    checkResult.innerText = "이미 사용 중입니다.";
                    checkResult.style.color = "red";
                    isChecked = false;
                } else {
                    checkResult.innerText = "사용 가능한 닉네임입니다.";
                    checkResult.style.color = "green";
                    isChecked = true;
                }
            });
    }

    function submitNickname() {
        const nickname = document.getElementById("nickname").value.trim();
        const accessToken = localStorage.getItem("accessToken");
        const token = "Bearer " + accessToken;

        if (!nickname) {
            alert("닉네임을 입력해주세요.");
            return;
        }

        if (!isChecked) {
            alert("닉네임 중복 확인을 먼저 해주세요.");
            return;
        }

        if (!accessToken) {
            alert("로그인이 필요합니다.");
            location.href = "/login.html";
            return;
        }

        fetch("/mypage/user-nickname", {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token
            },
            body: JSON.stringify({ nickname })
        })
            .then(res => {
                if (res.ok) {
                    alert("닉네임이 성공적으로 변경되었습니다.");
                    location.href = "/mypage/account/view";
                } else {
                    return res.json().then(err => {
                        alert(err.message || "닉네임 변경 실패");
                    });
                }
            })
            .catch(() => {
                alert("서버와 연결할 수 없습니다.");
            });
    }

    // 입력값이 바뀌면 중복 확인 상태 초기화
    document.getElementById("nickname").addEventListener("input", () => {
        isChecked = false;
        document.getElementById("checkResult").innerText = "";
    });
</script>
</body>
</html>
